version: 1
frontend:
  phases:
    preBuild:
      commands:
        - nvm use 20
        - cd frontend
        - npm ci
    build:
      commands:
        - npm run build
        - echo "Build completed, verifying files..."
        - ls -la dist/
        - ls -la dist/assets/
        - echo "Copying critical files to root for Amplify compatibility..."
        - cp dist/assets/*.css dist/ 2>/dev/null || true
        - cp dist/assets/*.js dist/ 2>/dev/null || true
        - echo "Files after copy:"
        - ls -la dist/
    postBuild:
      commands:
        - echo "Setting up custom server rules..."
        - echo "Verifying _redirects and _headers files..."
        - cat dist/_redirects 2>/dev/null || echo "No _redirects found"
        - cat dist/_headers 2>/dev/null || echo "No _headers found"
  artifacts:
    baseDirectory: frontend/dist
    files:
      - '**/*'
  cache:
    paths:
      - frontend/node_modules/**/*
customHeaders:
  - pattern: '**/*.css'
    headers:
      - key: 'Content-Type'
        value: 'text/css; charset=utf-8'
      - key: 'Cache-Control'
        value: 'public, max-age=31536000'
  - pattern: '**/*.js'
    headers:
      - key: 'Content-Type'
        value: 'application/javascript; charset=utf-8'
      - key: 'Cache-Control'
        value: 'public, max-age=31536000'
  - pattern: '*.css'
    headers:
      - key: 'Content-Type'
        value: 'text/css; charset=utf-8'
  - pattern: '*.js'
    headers:
      - key: 'Content-Type'
        value: 'application/javascript; charset=utf-8'