# Implementaci√≥n de Duraci√≥n de Servicios en Optimizaci√≥n de Rutas

**Fecha**: 21 de octubre de 2025  
**Estado**: ‚úÖ Implementado  
**Prioridad**: CR√çTICA

---

## üìã Resumen Ejecutivo

Se implement√≥ el manejo correcto de la **duraci√≥n de servicios** en el algoritmo de optimizaci√≥n de rutas y la interfaz de usuario. Antes de este cambio, el sistema usaba una duraci√≥n hardcoded de 60 minutos para todos los servicios, lo que causaba c√°lculos incorrectos para servicios m√°s cortos (ej: corte de cabello 30min) o m√°s largos (ej: keratina 120min).

---

## üéØ Objetivos

### Problema Identificado
1. ‚ùå **Algoritmo usaba duraci√≥n hardcoded**: `SERVICE_DURATION_MINUTES = 60` para todos los servicios
2. ‚ùå **UI no mostraba duraci√≥n**: La tabla de reprogramaci√≥n no indicaba cu√°nto dura cada servicio
3. ‚ùå **Tipo incompleto**: `RescheduledAppointment` no inclu√≠a campo `durationMinutes`
4. ‚ùå **C√°lculos incorrectos**: Horarios propuestos no reflejaban la duraci√≥n real del servicio

### Impacto en Producci√≥n
- **Servicios cortos (30min)**: Generaban gaps de 30min innecesarios
- **Servicios largos (120min)**: Causaban solapamiento de citas
- **Confianza del usuario**: No pod√≠an verificar si los horarios propuestos eran correctos

---

## ‚úÖ Soluci√≥n Implementada

### 1. Actualizaci√≥n de Tipos (TypeScript)

#### Frontend: `/nextjs-app/src/services/api/availabilityService.ts`
```typescript
export interface RescheduledAppointment {
  appointmentId: string;
  clientName: string;
  serviceType: string;
  locationId: string;
  locationName: string;
  originalStartTime: string;
  originalEndTime: string;
  proposedStartTime: string;
  proposedEndTime: string;
  timeDifferenceMinutes: number;
  durationMinutes: number; // ‚ú® NUEVO: Duraci√≥n del servicio
  specialistId: string;
  specialistName: string;
  status: 'proposed' | 'approved' | 'rejected';
  reason?: string;
}
```

#### Backend: `/lambdas/data-handler/src/types/availability.ts`
```typescript
export interface RescheduledAppointment {
  // ... campos existentes
  durationMinutes: number; // ‚ú® NUEVO: Duraci√≥n estimada en minutos
  // ...
}
```

#### Algoritmo: `/nextjs-app/src/services/optimization/routeOptimizerWithRescheduling.ts`
```typescript
export interface Appointment {
  id: string;
  locationId: string;
  locationName: string;
  clientName: string;
  serviceType: string;
  startTime: string;
  endTime: string;
  estimatedDuration: number; // ‚ú® NUEVO: Duraci√≥n del servicio en minutos
  location: {
    lat: number;
    lng: number;
    address: string;
  };
}
```

---

### 2. Modificaci√≥n del Algoritmo de Optimizaci√≥n

#### Antes (Hardcoded)
```typescript
const SERVICE_DURATION_MINUTES = 60; // ‚ùå Valor fijo para todos

// Sumar duraci√≥n del servicio
currentTime = new Date(currentTime.getTime() + SERVICE_DURATION_MINUTES * 60 * 1000);
```

#### Despu√©s (Duraci√≥n Real)
```typescript
const SERVICE_DURATION_MINUTES = 60; // Solo como fallback

/**
 * Calcula horarios propuestos para una ruta optimizada
 * IMPORTANTE: Usa la duraci√≥n real de cada servicio (estimatedDuration)
 */
function calculateProposedTimes(
  route: Appointment[],
  userLocation: { lat: number; lng: number },
  startTime: Date
): { appointmentId: string; proposedTime: Date }[] {
  const proposedTimes: { appointmentId: string; proposedTime: Date }[] = [];
  let currentTime = new Date(startTime);
  let currentLat = userLocation.lat;
  let currentLng = userLocation.lng;
  
  for (const appointment of route) {
    // Calcular tiempo de viaje
    const distance = calculateDistance(
      currentLat,
      currentLng,
      appointment.location.lat,
      appointment.location.lng
    );
    const travelTimeMinutes = (distance / AVERAGE_SPEED_KMH) * 60;
    
    // Sumar tiempo de viaje
    currentTime = new Date(currentTime.getTime() + travelTimeMinutes * 60 * 1000);
    
    // Guardar horario propuesto
    proposedTimes.push({
      appointmentId: appointment.id,
      proposedTime: new Date(currentTime)
    });
    
    // ‚ú® Sumar duraci√≥n REAL del servicio (no hardcoded)
    const serviceDuration = appointment.estimatedDuration || SERVICE_DURATION_MINUTES;
    currentTime = new Date(currentTime.getTime() + serviceDuration * 60 * 1000);
    currentLat = appointment.location.lat;
    currentLng = appointment.location.lng;
  }
  
  return proposedTimes;
}
```

#### C√°lculo de `endTime` con Duraci√≥n Real
```typescript
// Usar horario propuesto (aunque tenga conflicto) con duraci√≥n real
const serviceDuration = appointment.estimatedDuration || SERVICE_DURATION_MINUTES;
return {
  ...appointment,
  startTime: proposedTime.proposedTime.toISOString(),
  endTime: new Date(proposedTime.proposedTime.getTime() + serviceDuration * 60 * 1000).toISOString()
};
```

#### Enriquecimiento de Resultados
```typescript
// 8. Enriquecer informaci√≥n de reprogramaci√≥n con duraci√≥n del servicio
const rescheduledAppointments = available.map(a => {
  const originalAppointment = appointments.find(app => app.id === a.appointmentId);
  return {
    ...a,
    clientName: originalAppointment?.clientName || '',
    locationName: originalAppointment?.locationName || '',
    durationMinutes: originalAppointment?.estimatedDuration || SERVICE_DURATION_MINUTES // ‚ú® NUEVO
  };
});
```

---

### 3. Actualizaci√≥n del Hook de Optimizaci√≥n

**Archivo**: `/nextjs-app/src/hooks/useRouteOptimizationWithRescheduling.ts`

```typescript
// Convertir appointments al formato esperado (incluyendo estimatedDuration)
const appointmentsForOptimization = appointmentsWithLocation.map(apt => ({
  id: apt.appointmentId,
  locationId: apt.locationId,
  locationName: apt.locationName || apt.location?.name || '',
  clientName: apt.customerName,
  serviceType: apt.serviceType,
  startTime: apt.startTime,
  endTime: apt.endTime,
  estimatedDuration: apt.estimatedDuration, // ‚ú® Pasar duraci√≥n real
  location: {
    lat: apt.location!.latitude,
    lng: apt.location!.longitude,
    address: apt.location!.address
  }
}));
```

---

### 4. Actualizaci√≥n de la UI - Tabla de Reprogramaci√≥n

**Archivo**: `/nextjs-app/src/components/dashboard/ReschedulingProposalTable.tsx`

#### Helper de Formato
```typescript
// Helper para formatear duraci√≥n
const formatDuration = (minutes: number): string => {
  const hours = Math.floor(minutes / 60);
  const mins = minutes % 60;
  
  if (hours === 0) return `${mins}min`;
  if (mins === 0) return `${hours}h`;
  return `${hours}h ${mins}min`;
};
```

#### Nueva Columna en Header
```tsx
<thead className="bg-gray-50 border-b border-gray-200">
  <tr>
    <th className="px-4 py-3 text-left font-semibold text-gray-700">Cliente</th>
    <th className="px-4 py-3 text-left font-semibold text-gray-700">Ubicaci√≥n</th>
    <th className="px-4 py-3 text-left font-semibold text-gray-700">Servicio</th>
    <th className="px-4 py-3 text-center font-semibold text-gray-700">Duraci√≥n</th> {/* ‚ú® NUEVO */}
    <th className="px-4 py-3 text-center font-semibold text-gray-700">Horario Original</th>
    <th className="px-4 py-3 text-center font-semibold text-gray-700">‚Üí</th>
    <th className="px-4 py-3 text-center font-semibold text-gray-700">Horario Propuesto</th>
    <th className="px-4 py-3 text-center font-semibold text-gray-700">Diferencia</th>
    <th className="px-4 py-3 text-left font-semibold text-gray-700">Especialista</th>
  </tr>
</thead>
```

#### Nueva Columna en Body
```tsx
<td className="px-4 py-3 text-center">
  <div className="inline-flex items-center gap-1 px-2 py-1 bg-blue-100 text-blue-700 rounded">
    <span className="text-xs">‚è±Ô∏è</span>
    <span className="font-semibold">{formatDuration(appointment.durationMinutes)}</span>
  </div>
</td>
```

---

### 5. Actualizaci√≥n del Lambda Backend

**Archivo**: `/lambdas/data-handler/src/handlers/availability.ts`

```typescript
if (allAvailable) {
  // ¬°Disponible!
  const endTime = addMinutesToTime(time, durationMinutes);
  available.push({
    appointmentId,
    clientName: '',
    serviceType,
    locationId,
    locationName: '',
    originalStartTime: requestedTime,
    originalEndTime: addMinutesToTime(requestedTime.split('T')[1].substring(0, 5), durationMinutes),
    proposedStartTime: requestedTime,
    proposedEndTime: endTime,
    timeDifferenceMinutes: 0,
    durationMinutes, // ‚ú® Incluir duraci√≥n del servicio
    specialistId: schedule.specialistId,
    specialistName: schedule.specialistName,
    status: 'proposed',
    reason: 'Horario confirmado'
  });
  foundAvailability = true;
  break;
}
```

---

## üìä Archivos Modificados

### Frontend (Next.js)
1. ‚úÖ `/nextjs-app/src/services/api/availabilityService.ts` - Tipo `RescheduledAppointment`
2. ‚úÖ `/nextjs-app/src/services/optimization/routeOptimizerWithRescheduling.ts` - Algoritmo
3. ‚úÖ `/nextjs-app/src/hooks/useRouteOptimizationWithRescheduling.ts` - Hook de conversi√≥n
4. ‚úÖ `/nextjs-app/src/components/dashboard/ReschedulingProposalTable.tsx` - UI de tabla

### Backend (Lambda)
5. ‚úÖ `/lambdas/data-handler/src/types/availability.ts` - Tipo `RescheduledAppointment`
6. ‚úÖ `/lambdas/data-handler/src/handlers/availability.ts` - Handler de API
7. ‚úÖ Lambda compilado (`npm run build` exitoso)

---

## üß™ Casos de Prueba

### Escenario 1: Servicio Corto (30 minutos)
**Input**: Corte de cabello - `estimatedDuration: 30`

**Antes**:
- Algoritmo usa 60min
- Gap de 30min innecesario
- UI no muestra duraci√≥n

**Despu√©s**:
- Algoritmo usa 30min
- Sin gaps innecesarios
- UI muestra "30min" en azul

### Escenario 2: Servicio Est√°ndar (60 minutos)
**Input**: Manicure - `estimatedDuration: 60`

**Antes**:
- Algoritmo usa 60min ‚úì
- UI no muestra duraci√≥n

**Despu√©s**:
- Algoritmo usa 60min ‚úì
- UI muestra "1h" en azul

### Escenario 3: Servicio Largo (120 minutos)
**Input**: Keratina - `estimatedDuration: 120`

**Antes**:
- Algoritmo usa 60min
- ‚ö†Ô∏è SOLAPAMIENTO: siguiente cita empieza 60min despu√©s pero servicio dura 120min
- UI no muestra duraci√≥n

**Despu√©s**:
- Algoritmo usa 120min ‚úì
- Sin solapamientos
- UI muestra "2h" en azul

### Escenario 4: Servicio con Minutos (90 minutos)
**Input**: Tinte - `estimatedDuration: 90`

**Antes**:
- Algoritmo usa 60min
- C√°lculo incorrecto por 30min de diferencia
- UI no muestra duraci√≥n

**Despu√©s**:
- Algoritmo usa 90min ‚úì
- C√°lculo correcto
- UI muestra "1h 30min" en azul

---

## üé® Mejoras Visuales en la Tabla

| Columna | Emoji | Color | Formato |
|---------|-------|-------|---------|
| Duraci√≥n | ‚è±Ô∏è | `bg-blue-100 text-blue-700` | "30min", "1h", "1h 30min", "2h" |
| Original | ‚è∞ | `bg-red-100 text-red-700` | "08:00", "14:30" |
| Propuesta | ‚úì | `bg-green-100 text-green-700` | "09:30", "15:00" |

**Ejemplo visual**:
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Cliente ‚îÇ Ubicaci√≥n‚îÇ Servicio ‚îÇ Duraci√≥n ‚îÇ Original‚îÇ ‚Üí ‚îÇ Propuesto‚îÇ Diferencia ‚îÇ Especialista‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ Ana G.  ‚îÇüìç Centro ‚îÇ Corte    ‚îÇ‚è±Ô∏è 30min  ‚îÇ‚è∞ 08:00 ‚îÇ ‚Üí ‚îÇ‚úì 09:30   ‚îÇ+90min      ‚îÇüë§ Mar√≠a L.  ‚îÇ
‚îÇ Carlos  ‚îÇüìç Norte  ‚îÇ Keratina ‚îÇ‚è±Ô∏è 2h     ‚îÇ‚è∞ 10:00 ‚îÇ ‚Üí ‚îÇ‚úì 11:00   ‚îÇ+60min      ‚îÇüë§ Laura P.  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üîç Flujo de Datos Completo

```
1. Dashboard Page
   ‚Üì fetchUpcomingAppointments()
   ‚Üì appointments: Appointment[] (con estimatedDuration)

2. useRouteOptimizationWithRescheduling Hook
   ‚Üì Mapea Appointment ‚Üí Appointment (algoritmo)
   ‚Üì Incluye: estimatedDuration

3. buildOptimizedRouteWithRescheduling()
   ‚Üì calculateProposedTimes()
   ‚Üì Usa: appointment.estimatedDuration
   ‚Üì Calcula: nextTime = currentTime + serviceDuration + travelTime

4. checkMultipleAvailability() API
   ‚Üì POST /availability/check-multiple
   ‚Üì Body: { appointments: [{ durationMinutes }] }

5. Lambda Handler (availability.ts)
   ‚Üì Verifica disponibilidad con duraci√≥n real
   ‚Üì Retorna: RescheduledAppointment[] con durationMinutes

6. Frontend enriquece resultados
   ‚Üì Agrega: clientName, locationName, durationMinutes

7. ReschedulingProposalTable
   ‚Üì Muestra: formatDuration(durationMinutes)
   ‚Üì Renderiza: "30min", "1h", "1h 30min", "2h"
```

---

## üì¶ Deployment

### Frontend (Next.js)
```bash
cd /Users/oscarkof/repos/TG-OM/nextjs-app
npm run build
# O autom√°tico con Amplify
```

### Backend (Lambda)
```bash
cd /Users/oscarkof/repos/TG-OM/lambdas/data-handler
npm run build  # ‚úÖ Compilado exitosamente

cd /Users/oscarkof/repos/TG-OM/infrastructure
cdk deploy DataStack --force
```

---

## ‚úÖ Checklist de Verificaci√≥n

### Pre-Deployment
- [x] Tipos actualizados (frontend + backend)
- [x] Algoritmo usa `estimatedDuration`
- [x] Hook pasa duraci√≥n correctamente
- [x] Lambda incluye `durationMinutes` en respuesta
- [x] Tabla muestra columna de duraci√≥n
- [x] Lambda compilado sin errores
- [x] Documentaci√≥n creada

### Post-Deployment
- [ ] DataStack desplegado
- [ ] Dashboard muestra columna "Duraci√≥n"
- [ ] Duraci√≥n formateada correctamente (30min, 1h, 1h 30min)
- [ ] Optimizaci√≥n usa duraciones reales
- [ ] Horarios propuestos son correctos
- [ ] No hay solapamientos para servicios largos
- [ ] No hay gaps para servicios cortos

---

## üêõ Troubleshooting

### Problema: Columna de duraci√≥n no aparece
**Causa**: Frontend no actualizado  
**Soluci√≥n**: Refrescar navegador (`Cmd+Shift+R`) o reiniciar servidor Next.js

### Problema: Duraci√≥n siempre muestra 60min
**Causa**: Base de datos no tiene `estimatedDuration`  
**Soluci√≥n**: Verificar que appointments en DynamoDB tienen el campo `estimatedDuration`

### Problema: Horarios propuestos incorrectos
**Causa**: Algoritmo no recibe duraci√≥n  
**Soluci√≥n**: Verificar que `appointmentsForOptimization` incluye `estimatedDuration`

### Problema: Error TypeScript en RescheduledAppointment
**Causa**: Tipo desactualizado  
**Soluci√≥n**: Verificar que ambos archivos (`availabilityService.ts` y `availability.ts`) tienen `durationMinutes`

---

## üìù Notas T√©cnicas

### Fallback de Seguridad
El sistema mantiene `SERVICE_DURATION_MINUTES = 60` como fallback por seguridad:
```typescript
const serviceDuration = appointment.estimatedDuration || SERVICE_DURATION_MINUTES;
```

Esto previene crashes si:
- Una cita no tiene `estimatedDuration` (datos legacy)
- Hay un error en la base de datos
- El campo viene como `null` o `undefined`

### Formato de Duraci√≥n Inteligente
La funci√≥n `formatDuration()` muestra el formato m√°s legible:
- `30` ‚Üí "30min"
- `60` ‚Üí "1h"
- `90` ‚Üí "1h 30min"
- `120` ‚Üí "2h"

### Precisi√≥n de C√°lculo
Los c√°lculos usan milisegundos para m√°xima precisi√≥n:
```typescript
currentTime = new Date(currentTime.getTime() + serviceDuration * 60 * 1000);
```

---

## üéØ Pr√≥ximos Pasos

1. **Verificar en Dashboard**: Refrescar `/dashboard` y confirmar que columna "Duraci√≥n" aparece
2. **Probar con datos reales**: Ejecutar optimizaci√≥n con citas de diferentes duraciones
3. **Validar c√°lculos**: Verificar que horarios propuestos son matem√°ticamente correctos
4. **Documentar en PROJECT_MEMORY.md**: Actualizar memoria del proyecto con esta feature

---

## üìö Referencias

- **Tipo Appointment**: `/nextjs-app/src/services/api/appointments.ts` (l√≠nea 8)
- **Algoritmo TSP**: `/nextjs-app/src/services/optimization/routeOptimizerWithRescheduling.ts`
- **API Availability**: `/lambdas/data-handler/src/handlers/availability.ts`
- **UI Fixes**: `/docs/UI_FIXES_OPTIMIZATION_CARD.md`
- **Sistema de Dise√±o**: `/docs/CLYOK_DESIGN_SYSTEM.md`

---

**Implementado por**: GitHub Copilot  
**Fecha**: 21 de octubre de 2025  
**Versi√≥n**: 1.0  
**Status**: ‚úÖ Listo para deployment
